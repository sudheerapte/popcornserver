#!/bin/sh
# Called from initialize to produce fliesdemo-index.html from assets
die() { echo $@ ; exit 1; }
[ -d ~/.popcorn ] || die No popcorn dir ~/.popcorn
grep -q fliesdemo ~/.popcorn/options.json ||
    die "options.json does not contain fliesdemo"
htmlfile=~/.popcorn/fliesdemo/fliesdemo-index.html
mkdir -p ~/.popcorn/fliesdemo &&
    rm -f ${htmlfile}
<< 'EOF2' cat > ${htmlfile} && echo Created fliesdemo-index.html
<html>
  <meta charset='utf-8'>
  <head><title>Flies Demo</title>
    <style>
      div { width: 640px; background: lightyellow; }
    </style>
</head>
  <body>
    <script id="provide" type="text/plain">
      DEF TOP CHILDREN board turn
      DEF ALT PARENT .board.a CHILDREN fly2 fly1 fly3 spider empty
      DEF ALT PARENT .board.b CHILDREN fly1 fly2 fly3 spider empty
      DEF ALT PARENT .board.c CHILDREN fly3 fly1 fly2 spider empty
      DEF ALT PARENT .board.d CHILDREN empty fly3 fly1 fly2 spider
      DEF ALT PARENT .board.e CHILDREN empty fly3 fly1 fly2 spider
      DEF ALT PARENT .board.f CHILDREN empty fly3 fly1 fly2 spider
      DEF ALT PARENT .board.g CHILDREN empty fly3 fly1 fly2 spider
      DEF ALT PARENT .board.h CHILDREN empty fly3 fly1 fly2 spider
      DEF ALT PARENT .turn CHILDREN spider flies win-spider win-flies
    </script>
    <script id="init" type="text/plain">
      WITH ALL .board.POS BEGIN
      DEF CON PARENT .loc.{{POS}} CHILDREN x y
      END

      DEF CON PARENT .loc.a CHILDREN x y
      DEF CON PARENT .loc.b CHILDREN x y
      DEF CON PARENT .loc.c CHILDREN x y
      DEF CON PARENT .loc.d CHILDREN x y
      DEF CON PARENT .loc.e CHILDREN x y
      DEF CON PARENT .loc.f CHILDREN x y
      DEF CON PARENT .loc.g CHILDREN x y
      DEF CON PARENT .loc.h CHILDREN x y

      SET DATAW PATH .loc.a.x DATA 500
      SET DATAW PATH .loc.a.y DATA 100
      SET DATAW PATH .loc.b.x DATA 200
      SET DATAW PATH .loc.b.y DATA 300
      SET DATAW PATH .loc.c.x DATA 800
      SET DATAW PATH .loc.c.y DATA 300
      SET DATAW PATH .loc.d.x DATA 500
      SET DATAW PATH .loc.d.y DATA 500
      SET DATAW PATH .loc.e.x DATA 200
      SET DATAW PATH .loc.e.y DATA 700
      SET DATAW PATH .loc.f.x DATA 500
      SET DATAW PATH .loc.f.y DATA 700
      SET DATAW PATH .loc.g.x DATA 800
      SET DATAW PATH .loc.g.y DATA 700
      SET DATAW PATH .loc.h.x DATA 500
      SET DATAW PATH .loc.h.y DATA 900

      DEF ALT PARENT .selectedfly CHILDREN fly1 fly2 fly3
      DEF CON PARENT .img CHILDREN fly1 fly2 fly3 spider empty
      DEF ALT PARENT .tomove CHILDREN spider fly1 fly2 fly3
      
      SET DATAW PATH .img.fly1 DATA fly
      SET DATAW PATH .img.fly2 DATA fly
      SET DATAW PATH .img.fly3 DATA fly
      SET DATAW PATH .img.spider DATA spider
      SET DATAW PATH .img.empty DATA emptyspot

    </script>
    <script id="render" type="text/plain">
    ON .turn spider BEGIN
      D .img.fly1 fly
      D .img.fly2 fly
      D .img.fly3 fly
      D .img.spider spider-selected
      C .tomove spider
    END
    ON .turn flies BEGIN
      D .img.spider spider
      D .img.fly1 fly
      D .img.fly2 fly
      D .img.fly3 fly
      D .img.{{CURRENT .selectedfly}} fly-selected
      C .tomove {{CURRENT .selectedfly}}
    END
    ON .selectedfly empty BEGIN
      D .img.empty emptyspot
    END
    ON .turn win-spider BEGIN
      D .img.fly1 emptyspot
      D .img.fly2 emptyspot
      D .img.fly3 emptyspot
      D .img.spider spider
    END
    ON .turn win-flies BEGIN
      D .img.fly1 fly
      D .img.fly2 fly
      D .img.fly3 fly
      D .img.spider emptyspot
    END
    </script>
    <div>
    <svg viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <g id="emptyspot">
        <circle cx="0" cy="0" r="48" fill="darkblue"/>
        <circle cx="0" cy="0" r="40" fill="lightgray"/>
        </g>
        <g id="spider">
EOF2

sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"170\"/
s/^[[:space:]]\+height\=.\+$/   height=\"131\"\n   x=\"-85\"\n   y=\"-65\"/' assets/spider.svg >>  ${htmlfile} &&
    echo '</g>\n<g id="spider-selected">' >>  ${htmlfile} &&
    echo copied spider.svg as spider &&
    sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"170\"/
s/^[[:space:]]\+height\=.\+$/   height=\"131\"\n   x=\"-85\"\n   y=\"-65\"/' assets/spider-excited.svg >>  ${htmlfile} &&
    echo copied spider-excited.svg as spider-selected &&
    echo '</g>\n<g id="fly">' >>  ${htmlfile} &&
    sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"145\"/
s/^[[:space:]]\+height\=.\+$/   height=\"150\"\n   x=\"-73\"\n   y=\"-75\"/' assets/flycute.svg >>  ${htmlfile} &&
    echo copied flycute.svg as fly &&
    echo '</g>\n<g id="fly-selected">' >>  ${htmlfile} &&
    sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"210\"/
s/^[[:space:]]\+height\=.\+$/   height=\"150\"\n   x=\"-105\"\n   y=\"-75\"/' assets/flycute-wings-out.svg >>  ${htmlfile} &&
    echo copied flycute-wings-out.svg as fly-selected &&
    cat >>  ${htmlfile} <<'EOF3' && echo wrote fliesdemo-index.html
        </g>
      </defs>
      <g id="lines" fill="transparent" stroke="darkblue" stroke-width="8">
        <path d="M 500 100 L 200 300 H 800 Z" />
        <path d="M 500 100 L 500 500 L 500 900" />
        <path d="M 200 300 L 800 700 M 800 300 L 200 700" />
        <path d="M 200 700 L 500 900 L 800 700" />
        <path d="M 200 300 V 700 H 800 V 300" />
      </g>
      <g id="drawspots">
        <use data-href="#{{DATAW .img.{{CURRENT .board.a}}}}"
             data-cmdclick="move {{CURRENT .tomove}} a"
             data-chgclick="C .selectedfly {{CURRENT .board.a}}"
             data-x="{{DATAW .loc.a.x}}" data-y="{{DATAW .loc.a.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.b}}}}"
             data-cmdclick="move {{CURRENT .tomove}} b"
             data-chgclick="C .selectedfly {{CURRENT .board.b}}"
             data-x="{{DATAW .loc.b.x}}" data-y="{{DATAW .loc.b.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.c}}}}"
             data-cmdclick="move {{CURRENT .tomove}} c"
             data-chgclick="C .selectedfly {{CURRENT .board.c}}"
             data-x="{{DATAW .loc.c.x}}" data-y="{{DATAW .loc.c.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.d}}}}"
             data-cmdclick="move {{CURRENT .tomove}} d"
             data-chgclick="C .selectedfly {{CURRENT .board.d}}"
             data-x="{{DATAW .loc.d.x}}" data-y="{{DATAW .loc.d.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.e}}}}"
             data-cmdclick="move {{CURRENT .tomove}} e"
             data-chgclick="C .selectedfly {{CURRENT .board.e}}"
             data-x="{{DATAW .loc.e.x}}" data-y="{{DATAW .loc.e.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.f}}}}"
             data-cmdclick="move {{CURRENT .tomove}} f"
             data-chgclick="C .selectedfly {{CURRENT .board.f}}"
             data-x="{{DATAW .loc.f.x}}" data-y="{{DATAW .loc.f.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.g}}}}"
             data-cmdclick="move {{CURRENT .tomove}} g"
             data-chgclick="C .selectedfly {{CURRENT .board.g}}"
             data-x="{{DATAW .loc.g.x}}" data-y="{{DATAW .loc.g.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.h}}}}"
             data-cmdclick="move {{CURRENT .tomove}} h"
             data-chgclick="C .selectedfly {{CURRENT .board.h}}"
             data-x="{{DATAW .loc.h.x}}" data-y="{{DATAW .loc.h.y}}"/>
      </g>
    </svg>
    </div>
  </body>
</html>
EOF3
