#!/bin/sh
# Called from initialize to produce fliesdemo-index.html from assets
die() { echo $@ ; exit 1; }
[ -d ~/.popcorn ] || die No popcorn dir ~/.popcorn
grep -q fliesdemo ~/.popcorn/options.json ||
    die "options.json does not contain fliesdemo"
htmlfile=~/.popcorn/fliesdemo/fliesdemo-index.html
mkdir -p ~/.popcorn/fliesdemo &&
    rm -f ${htmlfile}
<< 'EOF2' cat > ${htmlfile} && echo Created fliesdemo-index.html
<html>
  <meta charset='utf-8'>
  <head><title>Flies Demo</title>
    <style>
      div { width: 640px; background: lightyellow; }
    </style>
</head>
  <body>
    <script id="provide" type="text/plain">
      P .board.a/fly2
      P .board.a/fly1
      P .board.a/fly3
      P .board.a/spider
      P .board.a/empty

      P .board.b/fly1
      P .board.b/fly2
      P .board.b/fly3
      P .board.b/spider
      P .board.b/empty

      P .board.c/fly3
      P .board.c/fly1
      P .board.c/fly2
      P .board.c/spider
      P .board.c/empty

      P .board.d/empty
      P .board.d/fly1
      P .board.d/fly2
      P .board.d/fly3
      P .board.d/spider

      P .board.e/empty
      P .board.e/fly1
      P .board.e/fly2
      P .board.e/fly3
      P .board.e/spider

      P .board.f/empty
      P .board.f/fly1
      P .board.f/fly2
      P .board.f/fly3
      P .board.f/spider

      P .board.g/empty
      P .board.g/fly1
      P .board.g/fly2
      P .board.g/fly3
      P .board.g/spider

      P .board.h/spider
      P .board.h/fly1
      P .board.h/fly2
      P .board.h/fly3
      P .board.h/empty

      P .turn/spider
      P .turn/flies
      P .turn/win-spider
      P .turn/win-flies

    </script>
    <script id="init" type="text/plain">
      P .loc.a.x
      P .loc.a.y
      P .loc.b.x
      P .loc.b.y
      P .loc.c.x
      P .loc.c.y
      P .loc.d.x
      P .loc.d.y
      P .loc.e.x
      P .loc.e.y
      P .loc.f.x
      P .loc.f.y
      P .loc.g.x
      P .loc.g.y
      P .loc.h.x
      P .loc.h.y

      D .loc.a.x 500
      D .loc.a.y 100
      D .loc.b.x 200
      D .loc.b.y 300
      D .loc.c.x 800
      D .loc.c.y 300
      D .loc.d.x 500
      D .loc.d.y 500
      D .loc.e.x 200
      D .loc.e.y 700
      D .loc.f.x 500
      D .loc.f.y 700
      D .loc.g.x 800
      D .loc.g.y 700
      D .loc.h.x 500
      D .loc.h.y 900

      P .selectedfly/fly1
      P .selectedfly/fly2
      P .selectedfly/fly3

      P .img.fly1
      P .img.fly2
      P .img.fly3
      P .img.spider
      P .img.empty

      P .tomove/spider
      P .tomove/fly1
      P .tomove/fly2
      P .tomove/fly3

      D .img.fly1 fly
      D .img.fly2 fly
      D .img.fly3 fly
      D .img.spider spider
      D .img.empty emptyspot
    </script>
    <script id="render" type="text/plain">
    ON .turn spider BEGIN
      D .img.fly1 fly
      D .img.fly2 fly
      D .img.fly3 fly
      D .img.spider spider-selected
      C .tomove spider
    END
    ON .turn flies BEGIN
      D .img.spider spider
      D .img.fly1 fly
      D .img.fly2 fly
      D .img.fly3 fly
      D .img.{{CURRENT .selectedfly}} fly-selected
      C .tomove {{CURRENT .selectedfly}}
    END
    ON .selectedfly empty BEGIN
      D .img.empty emptyspot
    END
    ON .turn win-spider BEGIN
      D .img.fly1 emptyspot
      D .img.fly2 emptyspot
      D .img.fly3 emptyspot
      D .img.spider spider
    END
    ON .turn win-flies BEGIN
      D .img.fly1 fly
      D .img.fly2 fly
      D .img.fly3 fly
      D .img.spider emptyspot
    END
    </script>
    <div>
    <svg viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <g id="emptyspot">
        <circle cx="0" cy="0" r="48" fill="darkblue"/>
        <circle cx="0" cy="0" r="40" fill="lightgray"/>
        </g>
        <g id="spider">
EOF2

sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"170\"/
s/^[[:space:]]\+height\=.\+$/   height=\"131\"\n   x=\"-85\"\n   y=\"-65\"/' assets/spider.svg >>  ${htmlfile} &&
    echo '</g>\n<g id="spider-selected">' >>  ${htmlfile} &&
    echo copied spider.svg as spider &&
    sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"170\"/
s/^[[:space:]]\+height\=.\+$/   height=\"131\"\n   x=\"-85\"\n   y=\"-65\"/' assets/spider-excited.svg >>  ${htmlfile} &&
    echo copied spider-excited.svg as spider-selected &&
    echo '</g>\n<g id="fly">' >>  ${htmlfile} &&
    sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"145\"/
s/^[[:space:]]\+height\=.\+$/   height=\"150\"\n   x=\"-73\"\n   y=\"-75\"/' assets/flycute.svg >>  ${htmlfile} &&
    echo copied flycute.svg as fly &&
    echo '</g>\n<g id="fly-selected">' >>  ${htmlfile} &&
    sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"210\"/
s/^[[:space:]]\+height\=.\+$/   height=\"150\"\n   x=\"-105\"\n   y=\"-75\"/' assets/flycute-wings-out.svg >>  ${htmlfile} &&
    echo copied flycute-wings-out.svg as fly-selected &&
    cat >>  ${htmlfile} <<'EOF3' && echo wrote fliesdemo-index.html
        </g>
      </defs>
      <g id="lines" fill="transparent" stroke="darkblue" stroke-width="8">
        <path d="M 500 100 L 200 300 H 800 Z" />
        <path d="M 500 100 L 500 500 L 500 900" />
        <path d="M 200 300 L 800 700 M 800 300 L 200 700" />
        <path d="M 200 700 L 500 900 L 800 700" />
        <path d="M 200 300 V 700 H 800 V 300" />
      </g>
      <g id="drawspots">
        <use data-href="#{{DATAW .img.{{CURRENT .board.a}}}}"
             data-cmdclick="move {{CURRENT .tomove}} a"
             data-chgclick="C .selectedfly {{CURRENT .board.a}}"
             data-x="{{DATAW .loc.a.x}}" data-y="{{DATAW .loc.a.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.b}}}}"
             data-cmdclick="move {{CURRENT .tomove}} b"
             data-chgclick="C .selectedfly {{CURRENT .board.b}}"
             data-x="{{DATAW .loc.b.x}}" data-y="{{DATAW .loc.b.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.c}}}}"
             data-cmdclick="move {{CURRENT .tomove}} c"
             data-chgclick="C .selectedfly {{CURRENT .board.c}}"
             data-x="{{DATAW .loc.c.x}}" data-y="{{DATAW .loc.c.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.d}}}}"
             data-cmdclick="move {{CURRENT .tomove}} d"
             data-chgclick="C .selectedfly {{CURRENT .board.d}}"
             data-x="{{DATAW .loc.d.x}}" data-y="{{DATAW .loc.d.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.e}}}}"
             data-cmdclick="move {{CURRENT .tomove}} e"
             data-chgclick="C .selectedfly {{CURRENT .board.e}}"
             data-x="{{DATAW .loc.e.x}}" data-y="{{DATAW .loc.e.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.f}}}}"
             data-cmdclick="move {{CURRENT .tomove}} f"
             data-chgclick="C .selectedfly {{CURRENT .board.f}}"
             data-x="{{DATAW .loc.f.x}}" data-y="{{DATAW .loc.f.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.g}}}}"
             data-cmdclick="move {{CURRENT .tomove}} g"
             data-chgclick="C .selectedfly {{CURRENT .board.g}}"
             data-x="{{DATAW .loc.g.x}}" data-y="{{DATAW .loc.g.y}}"/>
        <use data-href="#{{DATAW .img.{{CURRENT .board.h}}}}"
             data-cmdclick="move {{CURRENT .tomove}} h"
             data-chgclick="C .selectedfly {{CURRENT .board.h}}"
             data-x="{{DATAW .loc.h.x}}" data-y="{{DATAW .loc.h.y}}"/>
      </g>
    </svg>
    </div>
  </body>
</html>
EOF3
