#!/bin/sh
die() { echo $@ ; exit 1; }
[ -d ~/.popcorn ] || die No popcorn dir ~/.popcorn
grep -q fliesdemo ~/.popcorn/options.json ||
    die "options.json does not contain fliesdemo"
htmlfile=~/.popcorn/fliesdemo/fliesdemo-index.html
mkdir -p ~/.popcorn/fliesdemo &&
    rm -f ${htmlfile}
<< 'EOF2' cat > ${htmlfile} && echo Created fliesdemo-index.html
<html>
  <meta charset='utf-8'>
  <head><title>Flies Demo</title>
    <style>
      div { width: 640px; background: lightyellow; }
    </style>
</head>
  <body>
    <script id="init" type="text/plain">
      P .loc.a.x
      P .loc.a.y
      P .loc.b.x
      P .loc.b.y
      P .loc.c.x
      P .loc.c.y
      P .loc.d.x
      P .loc.d.y
      P .loc.e.x
      P .loc.e.y
      P .loc.f.x
      P .loc.f.y
      P .loc.g.x
      P .loc.g.y
      P .loc.h.x
      P .loc.h.y

      D .loc.a.x 500
      D .loc.a.y 100
      D .loc.b.x 200
      D .loc.b.y 300
      D .loc.c.x 800
      D .loc.c.y 300
      D .loc.d.x 500
      D .loc.d.y 500
      D .loc.e.x 200
      D .loc.e.y 700
      D .loc.f.x 500
      D .loc.f.y 700
      D .loc.g.x 800
      D .loc.g.y 700
      D .loc.h.x 500
      D .loc.h.y 900

      P .spider.pos/h
      P .spider.pos/a
      P .spider.pos/b
      P .spider.pos/c
      P .spider.pos/d
      P .spider.pos/e
      P .spider.pos/f
      P .spider.pos/g

      P .fly1.pos/a
      P .fly1.pos/b
      P .fly1.pos/c
      P .fly1.pos/d
      P .fly1.pos/e
      P .fly1.pos/f
      P .fly1.pos/g
      P .fly1.pos/h

      P .fly2.pos/b
      P .fly2.pos/a
      P .fly2.pos/c
      P .fly2.pos/d
      P .fly2.pos/e
      P .fly2.pos/f
      P .fly2.pos/g
      P .fly2.pos/h

      P .fly3.pos/c
      P .fly3.pos/a
      P .fly3.pos/b
      P .fly3.pos/d
      P .fly3.pos/e
      P .fly3.pos/f
      P .fly3.pos/g
      P .fly3.pos/h
    </script>
    <div>
    <svg viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <g id="spot">
        <circle cx="0" cy="0" r="48" fill="darkblue"/>
        <circle cx="0" cy="0" r="40" fill="lightgray"/>
        </g>
        <g id="spiderold">
        <circle cx="0" cy="0" r="55" fill="darkred"/>
        <circle cx="0" cy="0" r="25" fill="lightgray"/>
        </g>
        <g id="spider">
EOF2

sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"170\"/
s/^[[:space:]]\+height\=.\+$/   height=\"131\"\n   x=\"-85\"\n   y=\"-65\"/' a/spider.svg >>  ${htmlfile} &&
    echo '</g>\n<g id="fly">' >>  ${htmlfile} &&
    echo copied spider.svg &&
    sed  '1,/^[[:space:]]*$/d
s/^[[:space:]]\+width\=.\+$/   width=\"145\"/
s/^[[:space:]]\+height\=.\+$/   height=\"150\"\n   x=\"-73\"\n   y=\"-75\"/' a/flycute.svg >>  ${htmlfile} &&
    echo copied flycute.svg &&
    cat >>  ${htmlfile} <<'EOF3' && echo wrote fliesdemo-index.html
        </g>
      </defs>
      <g id="lines" fill="transparent" stroke="darkblue" stroke-width="8">
        <path d="M 500 100 L 200 300 H 800 Z" />
        <path d="M 500 100 L 500 500 L 500 900" />
        <path d="M 200 300 L 800 700 M 800 300 L 200 700" />
        <path d="M 200 700 L 500 900 L 800 700" />
        <path d="M 200 300 V 700 H 800 V 300" />
      </g>
      <g id="drawspots">
        <g id="uppermiddlespot" >
          <use href="#spot" x="500" y="100"
               data-chgclick="C .fly1.pos a"
               />
        </g>
        <g id="upperleftspot">
          <use href="#spot" x="200" y="300"
               data-chgclick="C .fly1.pos b"
               />
        </g>
        <use href="#spot" x="800" y="300" id="upperrightspot"
             data-chgclick="C .fly1.pos c"
             />
        <use href="#spot" x="500" y="500" id="centerspot"
             data-chgclick="C .fly1.pos d"
             />
        <use href="#spot" x="200" y="700" id="lowerleftspot"
             data-chgclick="C .fly1.pos e"
             />
        <use href="#spot" x="500" y="700" id="lowermiddlespot"
             data-chgclick="C .fly1.pos f"
             />
        <use href="#spot" x="800" y="700" id="lowerrightspot"
             data-chgclick="C .fly1.pos g"
             />
        <use href="#spot" x="500" y="900" id="lowestmiddlespot"
             data-chgclick="C .fly1.pos h"
             />
      </g>
      <g id="drawflies">
        <use href="#fly"
             data-x="DATA .loc.{{CURRENT .fly1.pos}}.x"
             data-y="DATA .loc.{{CURRENT .fly1.pos}}.y" />
        <use href="#fly"
             data-x="DATA .loc.{{CURRENT .fly2.pos}}.x"
             data-y="DATA .loc.{{CURRENT .fly2.pos}}.y" />
        <use href="#fly"
             data-x="DATA .loc.{{CURRENT .fly3.pos}}.x"
             data-y="DATA .loc.{{CURRENT .fly3.pos}}.y" />
        <use href="#spider"
             data-x="DATA .loc.{{CURRENT .spider.pos}}.x"
             data-y="DATA .loc.{{CURRENT .spider.pos}}.y"  />
      </g>
    </svg>
    </div>
  </body>
</html>
EOF3
